<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc reference="RateLimiter.RateLimiterAdmin" locale="">
  <web>RateLimiter</web>
  <name>RateLimiterAdmin</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>RateLimiter.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1479380779000</creationDate>
  <date>1479807276000</date>
  <contentUpdateDate>1479805421000</contentUpdateDate>
  <version>1.1</version>
  <title>RateLimiterAdmin</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <object>
    <class>
      <name>XWiki.ConfigurableClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <categoryIcon>
        <customDisplay/>
        <disabled>0</disabled>
        <name>categoryIcon</name>
        <number>11</number>
        <picker>0</picker>
        <prettyName>categoryIcon</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </categoryIcon>
      <codeToExecute>
        <customDisplay/>
        <disabled>0</disabled>
        <editor>Text</editor>
        <name>codeToExecute</name>
        <number>7</number>
        <picker>0</picker>
        <prettyName>codeToExecute</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </codeToExecute>
      <configurationClass>
        <customDisplay/>
        <disabled>0</disabled>
        <name>configurationClass</name>
        <number>3</number>
        <picker>0</picker>
        <prettyName>configurationClass</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </configurationClass>
      <configureGlobally>
        <customDisplay/>
        <defaultValue/>
        <disabled>0</disabled>
        <displayFormType>checkbox</displayFormType>
        <displayType/>
        <name>configureGlobally</name>
        <number>4</number>
        <prettyName>configureGlobally</prettyName>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </configureGlobally>
      <displayBeforeCategory>
        <customDisplay/>
        <disabled>0</disabled>
        <name>displayBeforeCategory</name>
        <number>10</number>
        <picker>0</picker>
        <prettyName>displayBeforeCategory</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </displayBeforeCategory>
      <displayInCategory>
        <customDisplay/>
        <disabled>0</disabled>
        <name>displayInCategory</name>
        <number>9</number>
        <picker>0</picker>
        <prettyName>displayInCategory</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </displayInCategory>
      <displayInSection>
        <customDisplay/>
        <disabled>0</disabled>
        <name>displayInSection</name>
        <number>1</number>
        <picker>0</picker>
        <prettyName>displayInSection</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </displayInSection>
      <heading>
        <customDisplay/>
        <disabled>0</disabled>
        <name>heading</name>
        <number>2</number>
        <picker>0</picker>
        <prettyName>heading</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </heading>
      <iconAttachment>
        <customDisplay/>
        <disabled>0</disabled>
        <name>iconAttachment</name>
        <number>8</number>
        <picker>0</picker>
        <prettyName>iconAttachment</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </iconAttachment>
      <linkPrefix>
        <customDisplay/>
        <disabled>0</disabled>
        <name>linkPrefix</name>
        <number>5</number>
        <picker>0</picker>
        <prettyName>linkPrefix</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </linkPrefix>
      <propertiesToShow>
        <cache>0</cache>
        <customDisplay/>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>propertiesToShow</name>
        <number>6</number>
        <picker>0</picker>
        <prettyName>propertiesToShow</prettyName>
        <relationalStorage>1</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>20</size>
        <sort>none</sort>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <values/>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </propertiesToShow>
      <sectionOrder>
        <customDisplay/>
        <disabled>0</disabled>
        <name>sectionOrder</name>
        <number>12</number>
        <numberType>integer</numberType>
        <prettyName>sectionOrder</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.NumberClass</classType>
      </sectionOrder>
    </class>
    <name>RateLimiter.RateLimiterAdmin</name>
    <number>0</number>
    <className>XWiki.ConfigurableClass</className>
    <guid>a40e177d-077e-4e58-a76e-e9d5c317d2b9</guid>
    <property>
      <categoryIcon/>
    </property>
    <property>
      <codeToExecute>{{display reference="RateLimiter.RateLimiterAdmin"/}}</codeToExecute>
    </property>
    <property>
      <configurationClass/>
    </property>
    <property>
      <configureGlobally>1</configureGlobally>
    </property>
    <property>
      <displayBeforeCategory/>
    </property>
    <property>
      <displayInCategory/>
    </property>
    <property>
      <displayInSection>Rate Limiter</displayInSection>
    </property>
    <property>
      <heading/>
    </property>
    <property>
      <iconAttachment/>
    </property>
    <property>
      <linkPrefix/>
    </property>
    <property>
      <propertiesToShow/>
    </property>
    <property>
      <sectionOrder/>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>RateLimiter.RateLimiterAdmin</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>8deeacf6-01f1-4e40-a796-546e60951a60</guid>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>require(['jquery', 'xwiki-events-bridge'], function($) {
  $(document).ready(function() {
    var form = $('#addlimiterform'),
        button = $('#addlimiterbutton'),
        modal = $('#rateLimiterModal'),
        classname = form.find('#classname').val(),
        form_token = form.find('#form_token').val();

    function clickHandler() {
      $('#ratelimiters').find('.deleteButton').on('click', function() {
        var nb = $(this).data('number');
        $.post(modal.data('deleteurl'),
               { 'ajax': 1, 'form_token': form_token, 'classname': classname, 'classid': nb},
               function() {
          var limit = livetable_ratelimiters.limit, total = livetable_ratelimiters.totalRows,
              offset = (livetable_ratelimiters.permalinks.getPage() - 1) * limit + 1;
          if (offset == total) offset -= limit;
          livetable_ratelimiters.clearCache(); //reset
          livetable_ratelimiters.showRows(offset, limit);
        }, 'text');
        return false;
      });
    }

    clickHandler();
    $(document).on('xwiki:livetable:ratelimiters:displayComplete', clickHandler);

    var limitInput = $('#RateLimiter\\.RateLimiterConfigClass_limit').addClass('xlivevalidation'),
        periodInput = $('#RateLimiter\\.RateLimiterConfigClass_period').addClass('xlivevalidation'),
        overflowInput = $('#RateLimiter\\.RateLimiterConfigClass_overflow').addClass('xlivevalidation'),
        validators = [
          new LiveValidation(limitInput.prop('id'), { validMessage: ''})
            .add(Validate.Presence, { failureMessage: modal.data('validation-presence') })
            .add(Validate.Numericality, { minimum: 1, onlyInteger: true, notANumberMessage: modal.data('validation-notanumber'), notAnIntegerMessage: modal.data('validation-notaninteger'), tooLowMessage: modal.data('validation-toolow').replace('\{0\}', '1')}),
          new LiveValidation(periodInput.prop('id'), { validMessage: ''})
            .add(Validate.Presence, { failureMessage: modal.data('validation-presence') })
            .add(Validate.Numericality, { minimum: 1, onlyInteger: true, notANumberMessage: modal.data('validation-notanumber'), notAnIntegerMessage: modal.data('validation-notaninteger'), tooLowMessage: modal.data('validation-toolow').replace('\{0\}', '1')}),
          new LiveValidation(overflowInput.prop('id'), { validMessage: ''})
            .add(Validate.Numericality, { minimum: 1, onlyInteger: true, notANumberMessage: modal.data('validation-notanumber'), notAnIntegerMessage: modal.data('validation-notaninteger'), tooLowMessage: modal.data('validation-toolow').replace('\{0\}', '1')})
            .add(Validate.Custom, {
              against: function(value, args) {
                return parseInt(value) &gt;= parseInt(limitInput.val());
              },
              failureMessage: modal.data('validation-overflowoverlimit')
            })
        ]

    button.click(function() {
      if (!LiveValidation.massValidate(validators)) {
        return;
      }
      button.prop('disabled', true);
      $.post(form.attr('action'),
             form.serialize(),
             function() {
        var limit = livetable_ratelimiters.limit, total = livetable_ratelimiters.totalRows,
            offset = Math.floor(total / limit) * limit + 1;
        livetable_ratelimiters.clearCache(); //reset
        livetable_ratelimiters.showRows(offset, limit);
        form.find('input:text').val('');
        modal.modal('hide');
        button.prop('disabled', false);
      });
    });

  });
});</code>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse/>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>6</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>code</name>
        <number>3</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>1</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>5</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>4</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>RateLimiter.RateLimiterAdmin</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>3e0db521-933e-4323-a6dc-8a255756bd22</guid>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>.xform .dualField input[type="text"], .dualField select {
  width: 50%;
}
.xform .dualField select {
  width: 25%;
}
.deleteButton {
  display: block;
  overflow: hidden;
  top: 2px;
  width: 16px;
  height: 16px;
  text-indent: 30px;
  line-height: 30px;
  background: transparent left top no-repeat url("$xwiki.getSkinFile('icons/silk/cross.png')");
}
.ratelimiterslt {
  width: 460px;
}</code>
    </property>
    <property>
      <contentType>CSS</contentType>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <content>{{velocity}}
#set ($discard = $services.localization.use('document', 'RateLimiter.Translations'))
$services.localization.render('ratelimiter.config.intro')

#if (!$hasAdmin)
{{error}}$services.localization.render('ratelimiter.config.error.norights'){{/error}}
#else
  == $services.localization.render('ratelimiter.config.ratelimiters') ==
  #set($columns = ['limit', 'period', 'overflow', 'actions'])
  #set($columnsProperties = {
      'limit' : { 'html' : true, 'sortable' : false },
      'period' : { 'html' : true, 'sortable' : false },
      'overflow' : { 'html' : true, 'sortable' : false },
      'actions': { 'html' : true, 'sortable' : false }
  })
  #set($options = {
      'resultPage': 'RateLimiter.RateLimiterLivetableResults',
      'translationPrefix' : 'ratelimiter.config.livetable.',
      'rowCount': 5,
      'pageSize' : false
  })
  #set ($discard = $xwiki.jsfx.use('uicomponents/widgets/validation/livevalidation_prototype.js', true))
  #set ($discard = $xwiki.ssfx.use('uicomponents/widgets/validation/livevalidation.css', true))
  #set ($discard = $xwiki.ssx.use('RateLimiter.RateLimiterAdmin'))
  #set ($discard = $xwiki.jsx.use('RateLimiter.RateLimiterAdmin',{'minify':'false'}))

  (% class="ratelimiterslt" %)
  (((
    #livetable("ratelimiters" $columns $columnsProperties $options)
  )))
  ##
  #set ($configDocument = $xwiki.getDocument('RateLimiter.Config'))
  #set ($configObj = $configDocument.newObject('RateLimiter.RateLimiterConfigClass'))
  #set ($discard = $configDocument.use($configObj))
  #macro(displayField $fieldName $unitField)
    ; &lt;label for="RateLimiter.RateLimiterConfigClass_$fieldName"&gt;$escapetool.xml($configDocument.displayPrettyName($fieldName, false, false))&lt;/label&gt;
    &lt;span class="xHint"&gt;$services.localization.render("RateLimiter.RateLimiterConfigClass_${fieldName}_tooltip")&lt;/span&gt;
    : #if ($!unitField)&lt;span class="dualField"&gt;#end
       $configDocument.displayEdit($configObj.getxWikiClass().get($fieldName), 'RateLimiter.RateLimiterConfigClass_', $configObj)#if($!unitField) $configDocument.displayEdit($configObj.getxWikiClass().get($unitField), 'RateLimiter.RateLimiterConfigClass_', $configObj)&lt;/span&gt;#end

  #end

  {{html wiki="true"}}
  &lt;button type="button" class="btn btn-primary" data-toggle="modal" data-target="#rateLimiterModal"&gt;
    $services.localization.render('ratelimiter.modal.button.show')
  &lt;/button&gt;
  &lt;div id="rateLimiterModal" class="modal fade" tabindex="-1" role="dialog" data-deleteurl="$xwiki.getURL('RateLimiter.Config','objectremove')" data-validation-presence="$escapetool.xml($services.localization.render('ratelimiter.validation.presence'))" data-validation-notanumber="$escapetool.xml($services.localization.render('ratelimiter.validation.notANumber'))" data-validation-notaninteger="$escapetool.xml($services.localization.render('ratelimiter.validation.notAnInteger'))" data-validation-toolow="$escapetool.xml($services.localization.render('ratelimiter.validation.tooLow'))" data-validation-overflowoverlimit="$escapetool.xml($services.localization.render('ratelimiter.validation.overflowOverLimit'))"&gt;
    &lt;div class="modal-dialog" role="document"&gt;
      &lt;div class="modal-content"&gt;
        &lt;div class="modal-header"&gt;
          &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close"&gt;&lt;span aria-hidden="true"&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
          &lt;h4 class="modal-title"&gt;$services.localization.render('ratelimiter.modal.title')&lt;/h4&gt;
        &lt;/div&gt;
        &lt;div class="modal-body"&gt;
          &lt;form id="addlimiterform" class="xform" action="$xwiki.getURL('RateLimiter.Config','objectadd')"&gt;
            &lt;input type="hidden" id="form_token" name="form_token" value="$services.csrf.token"&gt;
            &lt;input type="hidden" id="classname" name="classname" value="RateLimiter.RateLimiterConfigClass"&gt;
            #displayField('limit')
            #displayField('period' 'unit')
            #displayField('overflow')
          &lt;/form&gt;
        &lt;/div&gt;
        &lt;div class="modal-footer"&gt;
          &lt;button type="button" class="btn btn-default" data-dismiss="modal"&gt;$services.localization.render('ratelimiter.modal.button.cancel')&lt;/button&gt;
          &lt;button id="addlimiterbutton" type="button" class="btn btn-primary"&gt;$services.localization.render('ratelimiter.modal.button.add')&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  {{/html}}

#end ## programming rights required
{{/velocity}}</content>
</xwikidoc>
